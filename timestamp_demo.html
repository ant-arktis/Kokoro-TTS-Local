<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kokoro TTS - Word Timestamp Demo</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .input-section {
            margin-bottom: 30px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            margin-bottom: 15px;
        }
        
        textarea {
            height: 100px;
            resize: vertical;
        }
        
        button {
            background-color: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }
        
        button:hover {
            background-color: #0056b3;
        }
        
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        .controls {
            margin: 20px 0;
            text-align: center;
        }
        
        .audio-player {
            width: 100%;
            margin: 20px 0;
        }
        
        .text-display {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 20px;
            margin: 20px 0;
            line-height: 1.8;
            font-size: 18px;
            min-height: 100px;
        }
        
        .word {
            display: inline-block;
            padding: 2px 4px;
            margin: 1px;
            border-radius: 3px;
            transition: all 0.2s ease;
        }
        
        .word.highlighted {
            background-color: #ffeb3b;
            color: #333;
            font-weight: bold;
            transform: scale(1.05);
        }
        
        .word.current {
            background-color: #ff5722;
            color: white;
            font-weight: bold;
            transform: scale(1.1);
        }
        
        .status {
            text-align: center;
            margin: 20px 0;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
        }
        
        .status.loading {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .timestamp-info {
            background-color: #e9ecef;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background-color: #007bff;
            width: 0%;
            transition: width 0.1s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸŽµ Kokoro TTS - Word Timestamp Demo</h1>
        
        <div class="input-section">
            <label for="text-input">Text to Convert:</label>
            <textarea id="text-input" placeholder="Enter text to convert to speech...">Hello, this is a demonstration of the Kokoro TTS API with word-level timestamps. You can see each word highlighted as it is spoken.</textarea>
            
            <label for="voice-select">Voice:</label>
            <select id="voice-select">
                <option value="">Loading voices...</option>
            </select>
            
            <label for="speed-input">Speed:</label>
            <input type="range" id="speed-input" min="0.5" max="2.0" step="0.1" value="1.0">
            <span id="speed-value">1.0x</span>
        </div>
        
        <div class="controls">
            <button id="generate-btn" onclick="generateTTS()">Generate Speech</button>
            <button id="play-btn" onclick="playAudio()" disabled>Play Audio</button>
            <button id="pause-btn" onclick="pauseAudio()" disabled>Pause</button>
            <button id="stop-btn" onclick="stopAudio()" disabled>Stop</button>
        </div>
        
        <div id="status" class="status" style="display: none;"></div>
        
        <div class="progress-bar">
            <div id="progress-fill" class="progress-fill"></div>
        </div>
        
        <audio id="audio-player" class="audio-player" controls style="display: none;"></audio>
        
        <div id="text-display" class="text-display" style="display: none;"></div>
        
        <div id="timestamp-info" class="timestamp-info" style="display: none;"></div>
    </div>

    <script>
        let wordTimestamps = [];
        let currentWordIndex = -1;
        let audio = null;
        
        // Load available voices
        async function loadVoices() {
            try {
                const response = await fetch('/tts/voices');
                const data = await response.json();
                
                const voiceSelect = document.getElementById('voice-select');
                voiceSelect.innerHTML = '';
                
                data.voices.forEach(voice => {
                    const option = document.createElement('option');
                    option.value = voice;
                    option.textContent = voice;
                    voiceSelect.appendChild(option);
                });
                
                if (data.voices.length > 0) {
                    voiceSelect.value = data.voices[0];
                }
            } catch (error) {
                console.error('Error loading voices:', error);
                showStatus('Error loading voices', 'error');
            }
        }
        
        // Update speed display
        document.getElementById('speed-input').addEventListener('input', function() {
            document.getElementById('speed-value').textContent = this.value + 'x';
        });
        
        // Generate TTS with timestamps
        async function generateTTS() {
            const text = document.getElementById('text-input').value.trim();
            const voice = document.getElementById('voice-select').value;
            const speed = parseFloat(document.getElementById('speed-input').value);
            
            if (!text) {
                showStatus('Please enter some text', 'error');
                return;
            }
            
            if (!voice) {
                showStatus('Please select a voice', 'error');
                return;
            }
            
            showStatus('Generating speech...', 'loading');
            document.getElementById('generate-btn').disabled = true;
            
            try {
                const response = await fetch('/tts/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        text: text,
                        voice: voice,
                        speed: speed,
                        include_timestamps: true
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                // Create audio from base64
                const audioBlob = new Blob([
                    Uint8Array.from(atob(data.audio), c => c.charCodeAt(0))
                ], { type: 'audio/wav' });
                
                const audioUrl = URL.createObjectURL(audioBlob);
                audio = new Audio(audioUrl);
                
                // Store word timestamps
                wordTimestamps = data.word_timestamps || [];
                
                // Display text with word highlighting
                displayTextWithWords(text);
                
                // Show timestamp info
                displayTimestampInfo(data);
                
                // Setup audio event listeners
                setupAudioListeners();
                
                // Enable controls
                document.getElementById('play-btn').disabled = false;
                document.getElementById('audio-player').src = audioUrl;
                document.getElementById('audio-player').style.display = 'block';
                
                showStatus(`Generated ${wordTimestamps.length} words in ${data.total_duration.toFixed(2)}s`, 'success');
                
            } catch (error) {
                console.error('Error generating TTS:', error);
                showStatus('Error generating speech: ' + error.message, 'error');
            } finally {
                document.getElementById('generate-btn').disabled = false;
            }
        }
        
        // Display text with word highlighting
        function displayTextWithWords(text) {
            const textDisplay = document.getElementById('text-display');
            textDisplay.innerHTML = '';
            textDisplay.style.display = 'block';
            
            // Split text into words and create spans
            const words = text.split(/\s+/);
            words.forEach((word, index) => {
                const wordSpan = document.createElement('span');
                wordSpan.className = 'word';
                wordSpan.textContent = word + ' ';
                wordSpan.dataset.wordIndex = index;
                textDisplay.appendChild(wordSpan);
            });
        }
        
        // Display timestamp information
        function displayTimestampInfo(data) {
            const timestampInfo = document.getElementById('timestamp-info');
            timestampInfo.style.display = 'block';
            
            let info = `Total Duration: ${data.total_duration.toFixed(2)}s\n`;
            info += `Sample Rate: ${data.sample_rate}Hz\n`;
            info += `Voice: ${data.voice}\n`;
            info += `Speed: ${data.speed}x\n\n`;
            info += `Word Timestamps (${wordTimestamps.length} words):\n`;
            
            wordTimestamps.forEach((wordData, index) => {
                info += `${index + 1}. "${wordData.word}": ${wordData.start_time.toFixed(2)}s - ${wordData.end_time.toFixed(2)}s\n`;
            });
            
            timestampInfo.textContent = info;
        }
        
        // Setup audio event listeners
        function setupAudioListeners() {
            if (!audio) return;
            
            audio.addEventListener('timeupdate', updateWordHighlighting);
            audio.addEventListener('ended', () => {
                clearWordHighlighting();
                document.getElementById('play-btn').disabled = false;
                document.getElementById('pause-btn').disabled = true;
                document.getElementById('stop-btn').disabled = true;
            });
        }
        
        // Update word highlighting based on current time
        function updateWordHighlighting() {
            if (!audio || wordTimestamps.length === 0) return;
            
            const currentTime = audio.currentTime;
            
            // Find the current word being spoken
            const currentWord = wordTimestamps.find((word, index) => 
                currentTime >= word.start_time && currentTime <= word.end_time
            );
            
            // Clear previous highlighting
            clearWordHighlighting();
            
            if (currentWord) {
                const wordIndex = wordTimestamps.indexOf(currentWord);
                const wordElement = document.querySelector(`[data-word-index="${wordIndex}"]`);
                
                if (wordElement) {
                    wordElement.classList.add('current');
                    currentWordIndex = wordIndex;
                }
            }
            
            // Update progress bar
            const progress = (currentTime / audio.duration) * 100;
            document.getElementById('progress-fill').style.width = progress + '%';
        }
        
        // Clear word highlighting
        function clearWordHighlighting() {
            document.querySelectorAll('.word').forEach(word => {
                word.classList.remove('current', 'highlighted');
            });
            currentWordIndex = -1;
        }
        
        // Audio control functions
        function playAudio() {
            if (audio) {
                audio.play();
                document.getElementById('play-btn').disabled = true;
                document.getElementById('pause-btn').disabled = false;
                document.getElementById('stop-btn').disabled = false;
            }
        }
        
        function pauseAudio() {
            if (audio) {
                audio.pause();
                document.getElementById('play-btn').disabled = false;
                document.getElementById('pause-btn').disabled = true;
            }
        }
        
        function stopAudio() {
            if (audio) {
                audio.pause();
                audio.currentTime = 0;
                clearWordHighlighting();
                document.getElementById('progress-fill').style.width = '0%';
                document.getElementById('play-btn').disabled = false;
                document.getElementById('pause-btn').disabled = true;
                document.getElementById('stop-btn').disabled = true;
            }
        }
        
        // Show status message
        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
            status.style.display = 'block';
            
            if (type !== 'loading') {
                setTimeout(() => {
                    status.style.display = 'none';
                }, 5000);
            }
        }
        
        // Initialize on page load
        window.addEventListener('load', () => {
            loadVoices();
        });
    </script>
</body>
</html> 